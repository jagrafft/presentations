// https://www.mayoclinic.org/medical-professionals/trauma/news/mass-casualty-triage-guidelines-revised/mac-20512735

// (edge_label,label)
def edge_labels = {
    (0, "") ;
    (1, "Yes") ;
    (2, "No") ;
    (3, "ALL Yes") ;
    (4, "ANY No") ;
    (5, "Child?") ;
}

// (u,v,edge_label)
def node_connections = {
    // Step 1
    (6,7,0) ;
    (7,8,0) ;
    // Step 2
    (9,10,0) ;
    (10,11,5) ;
    (10,12,0) ;
    (11,12,0) ;
    (12,13,0) ;
    (13,14,1) ;
    (13,5,2) ;
    (14,15,0) ;
    (15,16,0) ;
    (16,17,0) ;
    (17,19,3) ;
    (19,2,2) ;
    (19,1,1) ;
    (17,18,4) ;
    (18,3,1) ;
    (18,4,2) ;
}

// (node,label)
def node_labels = {
    (1,"ğ— ğ—¶ğ—»ğ—¶ğ—ºğ—®ğ—¹") ;
    (2,"ğ——ğ—²ğ—¹ğ—®ğ˜†ğ—²ğ—±") ;
    (3,"ğ—œğ—ºğ—ºğ—²ğ—±ğ—¶ğ—®ğ˜ğ—²") ;
    (4,"ğ—˜ğ˜…ğ—½ğ—²ğ—°ğ˜ğ—®ğ—»ğ˜") ;
    (5, "ğ——ğ—²ğ—®ğ—±") ;
    (6, "ğ—¦ğ˜ğ—¶ğ—¹ğ—¹/ğ—¼ğ—¯ğ˜ƒğ—¶ğ—¼ğ˜‚ğ˜€ ğ—¹ğ—¶ğ—³ğ—² ğ˜ğ—µğ—¿ğ—²ğ—®ğ˜\nAssess first") ;
    (7, "ğ—ªğ—®ğ˜ƒğ—²/ğ—½ğ˜‚ğ—¿ğ—½ğ—¼ğ˜€ğ—²ğ—³ğ˜‚ğ—¹ ğ—ºğ—¼ğ˜ƒğ—²ğ—ºğ—²ğ—»ğ˜\nAssess second") ;
    (8, "ğ—ªğ—®ğ—¹ğ—¸\nAssess third") ;
    (9, "Control major\nhemorrhage") ;
    (10, "Open airway") ;
    (11, "Consider two (2)\nrescue breaths") ;
    (12, "Auto-inject antidotes") ;
    (13, "Breathing?") ;
    (14, "Obeys commands or\nmakes purposeful movements?") ;
    (15, "Has peripheral pulse?") ;
    (16, "NOT in respiratory\ndistress?") ;
    (17, "Major hemorrhage\ncontrolled?") ;
    (18, "Likely to survive\ngiven current resources?") ;
    (19, "Minor injuries ONLY?") ;
}

def node_steps = {
    (:global, 6) ;
    (:global, 7) ;
    (:global, 8) ;
    (:individual, 1) ;
    (:individual, 2) ;
    (:individual, 3) ;
    (:individual, 4) ;
    (:individual, 5) ;
    (:individual, 9) ;
    (:individual, 10) ;
    (:individual, 11) ;
    (:individual, 12) ;
    (:individual, 13) ;
    (:individual, 14) ;
    (:individual, 15) ;
    (:individual, 16) ;
    (:individual, 17) ;
    (:individual, 18) ;
    (:individual, 19) ;
    (:lsi, 9) ;
    (:lsi, 10) ;
    (:lsi, 11) ;
    (:lsi, 12) ;
    (:unlabeled, 14) ;
    (:unlabeled, 15) ;
    (:unlabeled, 16) ;
    (:unlabeled, 17) ;
}

// (step,label)
def step_labels = {
    (:global, "ğ—¦ğ˜ğ—²ğ—½ ğŸ­\nGlobal sorting") ;
    (:individual, "ğ—¦ğ˜ğ—²ğ—½ ğŸ®\nIndividual assessment") ;
    (:lsi, "ğ—Ÿğ—¦ğ—œ") ;
    (:unlabeled, "") ;
}

def edge_styles = {
    (10,11,"dotted") ;
    (11,12,"dotted") ;
}

def node_styles = {
    (1, "color", "#00BC01") ;
    (1, "fillcolor", "#00BC01") ;
    (1, "fontcolor", "white") ;
    (1, "fontsize", "20") ;
    (2, "color", "#FEFE00") ;
    (2, "fillcolor", "#FEFE00") ;
    (2, "fontsize", "20") ;
    (3, "color", "red") ;
    (3, "fillcolor", "red") ;
    (3, "fontcolor", "white") ;
    (3, "fontsize", "20") ;
    (4, "color", "gray63") ;
    (4, "fillcolor", "gray63") ;
    (4, "fontcolor", "black") ;
    (4, "fontsize", "20") ;
    (5, "color", "black") ;
    (5, "fillcolor", "black") ;
    (5, "fontcolor", "white") ;
    (5, "fontsize", "20") ;
    (6, "fontsize", "20") ;
    (7, "fontsize", "20") ;
    (8, "fontsize", "20") ;
}

module global_sorting_step
    def node = node_steps[:global]
    def attribute:graph = {
        ("fontsize", "30") ;
        ("label", step_labels[:global]) ;
    }
end

module individual_assessment_step
    def node = node_steps[:individual]
    def attribute:graph = {
        ("fontsize", "30") ;
        ("label", step_labels[:individual]) ;
    }
end

module individual_assessment_step_LSI
    def node = node_steps[:lsi]
    def attribute:graph = {
        ("fontsize", "24") ;
        ("label", step_labels[:lsi]) ;
    }
    
    def parent = "individual"
end

module individual_assessment_step_unlabeled
    def node = node_steps[:unlabeled]
    def attribute:graph = {
        ("label", step_labels[:unlabeled]) ;
    }

    def parent = "individual"
end

module salt_triage_graph
    def edge(u,v) = node_connections(u,v,_)
    def node(n) = first[node_connections](n) or second[node_connections](n)

    def attribute:graph = {
        // ("nodesep", "1.5") ;
    }

    def subgraph = {
        ("global", global_sorting_step) ;
        ("individual", individual_assessment_step) ;
        ("lsi", individual_assessment_step_LSI) ;
        ("unlabeled", individual_assessment_step_unlabeled) ;
    }

    def edge_attribute[u in first[edge], v in edge[u]] = {
        ("label", edge_labels[node_connections[u,v]]) ;
        ("style", edge_styles[u,v]) ;
    }
    
    def node_attribute[n in node] = {
        ("label", node_labels[n]) ;
        ("shape", "rect") ;
        ("style", "filled") ;
        node_styles[n] ;
        // Add default color if needed
        (empty[node_styles[n,"color"]], { ("color", "#A4DCDC") ; ("fillcolor", "#A4DCDC") } )
    }
end

def salt_edges(u,v) = node_connections(u,v,_)
def G = directed_graph[salt_edges]
def PR1 = incremental_PR[G,{}]
def PR2 = incremental_PR[G,PR1]

module salt_triage_pagerank_graph
    def edge(u,v) = node_connections(u,v,_)
    def node(n) = first[node_connections](n) or second[node_connections](n)

    def attribute:graph = {
        // ("rankdir", "LR") ;
        ("nodesep", "1.15") ;
    }

    def subgraph = {
        ("global", global_sorting_step) ;
        ("individual", individual_assessment_step) ;
        ("lsi", individual_assessment_step_LSI) ;
        ("unlabeled", individual_assessment_step_unlabeled) ;
    }

    def edge_attribute[u in first[edge], v in edge[u]] = {
        ("fontsize", "30") ;
        ("label", decimal[64,3,PR2:pr[u]]) ;
        ("style", edge_styles[u,v]) ;
    }
    
    def node_attribute[n in node] = {
        ("height", 24*PR2:pr[n]) ;
        ("label", node_labels[n]) ;
        ("shape", "circle") ;
        ("style", "filled") ;
        ("width", 24*PR2:pr[n]) ;
        node_styles[n] ;
        // Add default color if needed
        (empty[node_styles[n,"color"]], { ("color", "#A4DCDC") ; ("fillcolor", "#A4DCDC") } )
    }
end

// def output = graphviz[salt_triage_graph]
// def output = graphviz[salt_triage_pagerank_graph]
